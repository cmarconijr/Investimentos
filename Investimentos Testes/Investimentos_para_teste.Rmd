---
title: "Investimentos Brasil -  "
author:
- "Secretaria de Comércio Exterior e Assuntos Econômicos(SCAEC)"
- "Núcleo de Inteligência Econômica(NIE)"
- "| Dados: Banco Central do Brasil"

date: " `r format(Sys.time(), '%d/%m/%Y')` "
output:
  pdf_document:
    latex_engine: lualatex
    toc: TRUE
    toc_depth: 3 
    number_sections: TRUE
organization:
toc-title: Índice
header-includes:
- \usepackage{fancyhdr}
- \usepackage{lscape}
- \usepackage{pdflscape}
- \usepackage{fancyhdr}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{graphicx}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage[normalem]{ulem}
- \usepackage{xcolor}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
- \pagestyle{fancy}
- \fancyhead{}
- \fancyhead[CO,CE]{Brasil - , Dados de Investimentos}
- \fancyfoot[CO,CE]{}
- \fancyfoot[LE,RO]{\thepage}
tables: yes
graphics: yes
---

```{r, echo=FALSE, message=FALSE, warning = FALSE}

# Ultima atualização feita 03/10/2022


library(tidyverse)
library(tinytex)
library(rbcb)
library(DT)
library(tidyr)
library(dplyr)
library(stringr)
library(zoo)
library(ggplot2)
library(RColorBrewer)
library(qpdf)
library(kableExtra)
library(ggthemes)
library(ggrepel)
library(readxl)
library(tools)
library(shades)
library(shiny)

#Se não tiver o pacote baixado baixe aqui 
#devtools::install_github("NIEscaec/Investimentos")
library(Investimentos)

``` 

  
  

```{r, echo=FALSE, message=FALSE, warning = FALSE}
 pais_titulo <- " "
```

---
title: "Investimentos Brasil - `r pais_titulo`"
--- 

```{r, echo=FALSE, message=FALSE, warning = FALSE}
  # Coloque aqui o pais ou paises que deseja gerar relatorio
  #
  # Recomendações para evitar ERRO:
  #
  # 1- Se for mais de um pais coleque em primeiro o pais que tenha dados de IDP e IDB

  pais <- c(" ")


```


```{r, echo=FALSE, message=FALSE, warning = FALSE, include=FALSE}

#----------------------------------------------------------- Puxa as tabelas do excel ---------------------------------------------
# Baixa a Planilha

httr::GET("https://www.bcb.gov.br/content/estatisticas/Documents/Tabelas_especiais/TabelasCompletasPosicaoIDP.xlsx",
          config = httr::config(ssl_verifypeer = F),
          httr::write_disk(here::here("data-raw", "TabelasCompletasPosicaoIDP.xlsx"), overwrite = T))



# Carrega a página 5 da Planilha IDP
Invest_Imediato_IDP <- ler_excel("data-raw/TabelasCompletasPosicaoIDP.xlsx", "5", 4)



# Carrega a página 6 da Planilha IDP
Control_Final_IDP <- ler_excel("data-raw/TabelasCompletasPosicaoIDP.xlsx", "6", 4)



# Carrega a página 7 da Planilha IDP
Oper_Intercomp_IDP <- ler_excel("data-raw/TabelasCompletasPosicaoIDP.xlsx", "7", 4)



# Carrega a página IDP ingresso por país da planilha Estrp
fluxo_Invest_InvEstrp <- ler_excel("data-raw/InvEstrp.xls","IDP ingresso por país", 4)



# Carrega a página Igressos por país da Planilha InterciaPassivo
Igressos_InterciaPassivo <- ler_excel("data-raw/InterciaPassivop.xls", "Ingressos por país", 4)



# Carrega a página Amortizações por país da Planilha InterciaPassivo
Amortizacoes_InterciaPassivo <- ler_excel("data-raw/InterciaPassivop.xls", "Amortizações por país", 4)




# Lista com os anos
anos <- c("2010", "2011", "2012", "2013", "2014", "2015",
          "2016", "2017", "2018", "2019", "2020")



# Carrega as linhas 1 a 6 da tabela 1
Invest_Imediato_IDP <- ler_linha(Invest_Imediato_IDP,12)
Control_Final_IDP <- ler_linha(Control_Final_IDP,12)
Oper_Intercomp_IDP <- ler_linha(Oper_Intercomp_IDP,12)
fluxo_Invest_InvEstrp <- ler_linha(fluxo_Invest_InvEstrp,12)
Igressos_InterciaPassivo <- ler_linha(Igressos_InterciaPassivo,12)
Amortizacoes_InterciaPassivo <- ler_linha(Amortizacoes_InterciaPassivo,12)



# realiza soma das linhas dos países e o pivot
Invest_Imediato_IDP <- soma_linhas(Invest_Imediato_IDP)
Control_Final_IDP <- soma_linhas(Control_Final_IDP)
Oper_Intercomp_IDP <- soma_linhas(Oper_Intercomp_IDP)
fluxo_Invest_InvEstrp <- soma_linhas(fluxo_Invest_InvEstrp)
Igressos_InterciaPassivo <- soma_linhas(Igressos_InterciaPassivo)
Amortizacoes_InterciaPassivo <- soma_linhas(Amortizacoes_InterciaPassivo)
fluxo_liq_IDP <- Igressos_InterciaPassivo - Amortizacoes_InterciaPassivo

#---------------------------------------------------------------------------------------------------------------------------------
#                                                            Parte 2
#---------------------------------------------------------------------------------------------------------------------------------

  httr::GET("https://www.bcb.gov.br/content/estatisticas/Documents/Tabelas_especiais/TabelasCompletasPosicaoIDE.xlsx",
          config = httr::config(ssl_verifypeer = F),
          httr::write_disk(here::here("data-raw", "TabelasCompletasPosicaoIDE.xlsx"), overwrite = T))




# Carrega a página 3 da Planilha IDE
Invest_Imediato_IDE <- ler_excel("data-raw/TabelasCompletasPosicaoIDE.xlsx", "3", 4)



# Carrega a página 9 da Planilha IDP
Oper_Intercomp_IDE <- ler_excel("data-raw/TabelasCompletasPosicaoIDE.xlsx", "9", 4)



# Carrega a página 11 da Planilha IDP
Acoes_IDE <- ler_excel("data-raw/TabelasCompletasPosicaoIDE.xlsx", "11", 4)


# Carrega a página 12 da Planilha IDP
RF_Curto_Prazo_IDE <- ler_excel("data-raw/TabelasCompletasPosicaoIDE.xlsx", "12", 4)


# Carrega a página 13 da Planilha IDP
RF_Longo_Prazo_IDE <- ler_excel("data-raw/TabelasCompletasPosicaoIDE.xlsx", "13", 4)


# Carrega a página 14 da Planilha IDP
Moedas_19_IDE <-ler_excel("data-raw/TabelasCompletasPosicaoIDE.xlsx", "14", 4)



# Carrega a página 15 da Planilha IDP
Moedas_20_IDE <- ler_excel("data-raw/TabelasCompletasPosicaoIDE.xlsx", "15", 4)



# Carrega a página 16 da Planilha IDP
Imoveis_19_IDE <- ler_excel("data-raw/TabelasCompletasPosicaoIDE.xlsx","16",4)



# Carrega a página 17 da Planilha IDP
Imoveis_20_IDE <- ler_excel("data-raw/TabelasCompletasPosicaoIDE.xlsx", "17", 4)



# Carrega a página IDE saídas por país da Planilha InvBrap
Fluxo_Invest_Imediatop_IDE <- ler_excel("data-raw/InvBrap.xls", "IDE saídas por país", 4)




moedas <- full_join(Moedas_19_IDE, Moedas_20_IDE, by = c("Discriminação"))
moedas <- select(moedas,Discriminação, anos)



imoveis <- full_join(Imoveis_19_IDE, Imoveis_20_IDE, by = c("Discriminação"))
imoveis <- select(imoveis,Discriminação, anos)




# Carrega as linhas 1 a 9 da tabela 2
Invest_Imediato_IDE <- ler_linha(Invest_Imediato_IDE,12)
Oper_Intercomp_IDE <- ler_linha(Oper_Intercomp_IDE,12)

Acoes_IDE <- ler_linha(Acoes_IDE,12)
RF_Curto_Prazo_IDE <- ler_linha(RF_Curto_Prazo_IDE,12)
RF_Longo_Prazo_IDE <- ler_linha(RF_Longo_Prazo_IDE,12)

moedas <- ler_linha(moedas,12)
imoveis <- ler_linha(imoveis,12)
Fluxo_Invest_Imediatop_IDE <- ler_linha(Fluxo_Invest_Imediatop_IDE,12)






# realiza soma das linhas dos países e o pivot
Invest_Imediato_IDE <- soma_linhas(Invest_Imediato_IDE)
Oper_Intercomp_IDE <- soma_linhas(Oper_Intercomp_IDE)

Acoes_IDE <- soma_linhas(Acoes_IDE)
RF_Curto_Prazo_IDE <- soma_linhas(RF_Curto_Prazo_IDE)
RF_Longo_Prazo_IDE <- soma_linhas(RF_Longo_Prazo_IDE)

moedas <- soma_linhas(moedas)
imoveis <- soma_linhas(imoveis)
Fluxo_Invest_Imediatop_IDE <- soma_linhas(Fluxo_Invest_Imediatop_IDE)
PG_IDE_invest_carteira <- Acoes_IDE + RF_Longo_Prazo_IDE + RF_Curto_Prazo_IDE

```















\newpage
# Investimentos do(a) `r pais_titulo` no Brasil
```{r, message=FALSE, echo=FALSE, warning = FALSE}
# ------------------------------------------------------ Cod Tabela1 ----------------------------------------------------------

# junta as linhas em uma só tabela
tabela1_plan1 <- bind_rows(Control_Final_IDP,Oper_Intercomp_IDP,Invest_Imediato_IDP,fluxo_Invest_InvEstrp,fluxo_liq_IDP)


setores_tab1 <- c("IDP-Participação no Capital(Control. Final)",
                  "IDP-Operações Intercompanhia",
                  "IDP-Participação no Capital(Invest.Imed)",
                  "Fluxo-Participação no Capital(Invest.Imed)",
                  "Fluxo Líquido-Operações Intercompanhia")


tabela1_plan1 <- criar_tabela(tabela1_plan1, setores_tab1)


# Divide a tabla em 2
tabela1_plan1.1 <- tabela1_plan1 %>% select(names, "2011", "2012", "2013", "2014", "2015")
tabela1_plan1.2 <- tabela1_plan1 %>% select(names, "2016", "2017", "2018", "2019", "2020")

tabela1_plan1.1 <- rename(tabela1_plan1.1, "Dado" = "names")
tabela1_plan1.2 <- rename(tabela1_plan1.2, "Dado" = "names")

tabela1_plan1.1 <- tabela1_plan1.1[c(1, 3, 2, 4, 5:nrow(tabela1_plan1.1)), ]
tabela1_plan1.2 <- tabela1_plan1.2[c(1, 3, 2, 4, 5:nrow(tabela1_plan1.2)), ]
```


```{r,echo=FALSE,menssage=FALSE,warning = FALSE, fig.width=8.5, fig.height=4.5, out.width = "100%"}
# ------------------------------------ * Grafico 1 * ------------------------------------ 

#------------------------------------------------------------------------------------------------------------------ 
 tab_grafico1 <- tabela1_plan1 
#------------------------------------------------------------------------------------------------------------------ 
 tab_grafico1 <- tab_grafico1 %>% 
   select(names,"2010","2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020")%>%
   pivot_longer(cols = "2010":"2020", names_to = "anos", values_to = "setores") 
#------------------------------------------------------------------------------------------------------------------ 
 
 a <- tab_grafico1 %>%
   filter("IDP-Participação no Capital(Control. Final)" == names)
 
 b <- tab_grafico1 %>%
   filter("IDP-Operações Intercompanhia" == names)
 
 c <- tab_grafico1 %>%
   filter("IDP-Participação no Capital(Invest.Imed)" == names)
 
#------------------------------------------------------------------------------------------------------------------  
 d <- tab_grafico1 %>%
   filter("Fluxo-Participação no Capital(Invest.Imed)" == names)
 
 e <- tab_grafico1 %>%
   filter("Fluxo Líquido-Operações Intercompanhia" == names)
 
# ------------------------------------------------------------------------------------------------------------------ 
  qanos <- nrow(a)
if(sum(a$setores) > 0 || sum(b$setores) > 0 || sum(c$setores) > 0 || sum(d$setores) > 0 || sum(e$setores) > 0){
  ggplot(a, aes(x = anos, y = setores), 
         b, aes(x = anos, y = setores), 
         c, aes(x = anos, y = setores), 
         d, aes(y = setores),
         e, aes(y = setores))+
          geom_bar( stat = "identity", aes(x = a$anos, y = a$setores, fill = "IDP - Participação no Capital (Controlador Final)"), 
                     position = position_nudge(x = -.20), width = .2)+
    
          geom_bar( stat = "identity", aes(x = b$anos, y = b$setores, fill = "IDP - Operações Intercompanhia"), 
                       position = position_nudge(x = -0), width = .2)+
    
          geom_bar(stat = "identity", aes(x = c$anos, y = c$setores, fill = "IDP - Participação no Capital (Invest. Imediato)"), 
                      position = position_nudge(x = .20), width = .2)+
    
          geom_line(aes(y = d$setores*3, group = " ", color = "Fluxo - Participação no Capital (Invest. Imediato)"), 
                    size = 1.1, linetype = 1)+
    
          geom_line(aes(y = e$setores*3, group = " ", color = "Fluxo Líquido - Operações Intercompanhia"), 
                    size = 1.1, linetype = 1)+
    
          geom_line(aes(y = -1, group = " " ),
                    size = 1, linetype = 2)+
   
          scale_y_continuous("US$ milhões", sec.axis = sec_axis(~ . /3 ))+
          scale_x_yearmon(NULL, format = "%Y", n = qanos)+
          scale_color_manual(NULL, values =  saturation(c("#B22222","#8A2BE2","#252A52","#FFC465","#66ADE5"), scalefac(0.8)))+
          scale_fill_manual(NULL, values = saturation(c("#252A52","#FFC465","#66ADE5","#B22222","#8A2BE2"), scalefac(0.8)))+
    
          theme_classic ()+
          theme(panel.grid = element_blank(), # remove as linhas do corpo do gráfico
          # sem bordas entre os painéis
          panel.spacing = unit(0, "cm"),
          # modifica o texto dos eixos
          axis.text = element_text(size = 12, colour = "black"),
          # cor dos marcadores
          axis.ticks = element_line(colour = "black"),
          # tamanho dos marcadores
          axis.ticks.length = unit(.2, "cm"),
          #cor da borda
          panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          legend.position="bottom", legend.box = "vertical")

}else{
  print("Sem dados suficientes para gerar o gráfico!")
}
 
```
 

```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}
# ------------------------------------ * Tabela 1 planilha 1 * ------------------------------------ 

  kableExtra::kable(tabela1_plan1.1,digits = 2, format = "markdown", align = 'llllccccccc')

```


```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}
# ------------------------------------ * Tabela 1 planilha 1 * ------------------------------------ 

 kableExtra::kable(tabela1_plan1.2,digits = 2, format = "markdown", align = 'llllcccccc')

```











\newpage
```{r, echo=FALSE, message=FALSE,warning = FALSE, message=FALSE, highlight=FALSE}

  if(length(pais) == 1){
    if(pais %in% lista_paises_IDP_CF){
      #====================================================================== COD Tabela 2==========================================================================
      #                                                                 Coluna Control. Final
      #=============================================================================================================================================================
    
                                                                   # ANO 2020
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2020_CF <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "14", range = "A5:AJ20")
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      linhas <- c(1, 2, 3, 7, 10, 11, 13, 15)
      ANO_2020_CF <- ANO_2020_CF[-linhas, ]
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2020_CF <- ANO_2020_CF %>% mutate(dplyr::across(.cols=2:36, .fns=as.numeric))
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2020_CF <- ANO_2020_CF %>%
        pivot_longer(
          cols = `Estados Unidos`:Indonésia,
          names_to = "pais",
          values_to = "valor")
    #====================================================================================================================================================================
    
                                                                              # ANO 2019
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2019_CF <-  read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "14", range = "A27:AJ42")
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2019_CF <- ANO_2019_CF[-linhas, ]
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2019_CF <- ANO_2019_CF %>%
        pivot_longer(
          cols = `Estados Unidos`:`Emirados Árabes Unidos`,
          names_to = "pais",
          values_to = "valor")
    #=============================================================================================================================================================
    
                                                                               # ANO 2018
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2018_CF <-  read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "14", range = "A48:AJ63")
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2018_CF <- ANO_2018_CF[-linhas, ]
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2018_CF <- ANO_2018_CF %>%
        pivot_longer(
          cols = `Estados Unidos`:Dinamarca,
          names_to = "pais",
          values_to = "valor")
    #====================================================================================================================================================================
    
                                                                             # ANO 2017
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2017_CF <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "14", range = "A70:AJ85")
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2017_CF <- ANO_2017_CF[-linhas, ]
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2017_CF <- ANO_2017_CF %>%
        pivot_longer(
          cols = `Estados Unidos`:Finlândia,
          names_to = "pais",
          values_to = "valor")
    #====================================================================================================================================================================
     
       #                                                                         ANO 2016
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2016_CF <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "14", range = "A92:AJ107")
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2016_CF <- ANO_2016_CF[-linhas, ]
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2016_CF <- ANO_2016_CF %>%
        pivot_longer(
          cols = `Estados Unidos`:Israel,
          names_to = "pais",
          values_to = "valor")
    #====================================================================================================================================================================
      
      #                                                                         ANO 2015
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2015_CF <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "14", range = "A112:AJ127")
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2015_CF <- ANO_2015_CF[-linhas, ]
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2015_CF <- ANO_2015_CF %>%
        pivot_longer(
          cols = `Estados Unidos`:Áustria,
          names_to = "pais",
          values_to = "valor")
    #===================================================================================================================================================================
    
    
      #                                                                         ANO 2014
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2014_CF <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "14", range = "A132:AJ147")
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2014_CF <- ANO_2014_CF[-linhas, ]
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2014_CF <- ANO_2014_CF %>%
        pivot_longer(
          cols = `Estados Unidos`:Colômbia,
          names_to = "pais",
          values_to = "valor")
    #===================================================================================================================================================================
    
    
      #                                                                         ANO 2013
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2013_CF <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "14", range = "A152:AJ167")
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2013_CF <- ANO_2013_CF[-linhas, ]
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2013_CF <- ANO_2013_CF %>%
        pivot_longer(
          cols = `Estados Unidos`:`África do Sul`,
          names_to = "pais",
          values_to = "valor")
    #===================================================================================================================================================================
    
      #                                                                         ANO 2012
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2012_CF <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx", sheet = "14", range = "A172:AJ187")
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2012_CF <- ANO_2012_CF[-linhas, ]
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2012_CF <- ANO_2012_CF %>%
        pivot_longer(
          cols = `Estados Unidos`:"Bahamas",
          names_to = "pais",
          values_to = "valor")
    #===================================================================================================================================================================
     
      #                                                                         ANO 2011
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2011_CF <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx", sheet = "14", range = "A192:AJ207")
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2011_CF <- ANO_2011_CF[-linhas, ]
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2011_CF <- ANO_2011_CF %>%
        pivot_longer(
          cols = `Estados Unidos`:`Ilha de Man`,
          names_to = "pais",
          values_to = "valor")
      #===================================================================================================================================================================
     
      #                                                                         ANO 2010
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2010_CF <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "14", range = "A212:AJ227")
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2010_CF <- ANO_2010_CF[-linhas, ]
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ANO_2010_CF <- ANO_2010_CF %>%
        pivot_longer(
          cols = `Estados Unidos`:"Angola",
          names_to = "pais",
          values_to = "valor")
      #===================================================================================================================================================================
      # Adiciona a coluna anos
      ANO_2010_CF$Ano <- "2010"
      ANO_2010_CF$Ano <- as.numeric(ANO_2010_CF$Ano)
    
      ANO_2011_CF$Ano <- "2011"
      ANO_2011_CF$Ano <- as.numeric(ANO_2011_CF$Ano)
    
      ANO_2012_CF$Ano <- "2012"
      ANO_2012_CF$Ano <- as.numeric(ANO_2012_CF$Ano)
    
      ANO_2013_CF$Ano <- "2013"
      ANO_2013_CF$Ano <- as.numeric(ANO_2013_CF$Ano)
    
      ANO_2014_CF$Ano <- "2014"
      ANO_2014_CF$Ano <- as.numeric(ANO_2014_CF$Ano)
    
      ANO_2015_CF$Ano <- "2015"
      ANO_2015_CF$Ano <- as.numeric(ANO_2015_CF$Ano)
    
      ANO_2016_CF$Ano <- "2016"
      ANO_2016_CF$Ano <- as.numeric(ANO_2016_CF$Ano)
    
      ANO_2017_CF$Ano <- "2017"
      ANO_2017_CF$Ano <- as.numeric(ANO_2017_CF$Ano)
    
      ANO_2018_CF$Ano <- "2018"
      ANO_2018_CF$Ano <- as.numeric(ANO_2018_CF$Ano)
    
      ANO_2019_CF$Ano <- "2019"
      ANO_2019_CF$Ano <- as.numeric(ANO_2019_CF$Ano)
    
      ANO_2020_CF$Ano <- "2020"
      ANO_2020_CF$Ano <- as.numeric(ANO_2020_CF$Ano)
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      # renomeia a coluna setor
      ANO_2010_CF <- ANO_2010_CF %>%
        rename("Setores" = `ANO: 2010`)
    
      ANO_2011_CF <- ANO_2011_CF %>%
        rename("Setores" = `ANO: 2011`)
    
      ANO_2012_CF <- ANO_2012_CF %>%
        rename("Setores" = `ANO: 2012`)
    
      ANO_2013_CF <- ANO_2013_CF %>%
        rename("Setores" = `ANO: 2013`)
    
      ANO_2014_CF <- ANO_2014_CF %>%
        rename("Setores" = `ANO: 2014`)
    
      ANO_2015_CF <- ANO_2015_CF %>%
        rename("Setores" = `ANO: 2015`)
    
      ANO_2016_CF <- ANO_2016_CF %>%
        rename("Setores" = `ANO: 2016`)
    
      ANO_2017_CF <- ANO_2017_CF %>%
        rename("Setores" = `ANO: 2017`)
    
      ANO_2018_CF <- ANO_2018_CF %>%
        rename("Setores" = `ANO: 2018`)
    
      ANO_2019_CF <- ANO_2019_CF %>%
        rename("Setores" = `ANO: 2019`)
    
      ANO_2020_CF <- ANO_2020_CF %>%
        rename("Setores" = `ANO: 2020`)
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      # junat em data frame só
      IDP_Por_Setor_Control_Final <- bind_rows(ANO_2020_CF, ANO_2019_CF, ANO_2018_CF, ANO_2017_CF, ANO_2016_CF, ANO_2015_CF, ANO_2014_CF, 
                                               ANO_2013_CF, ANO_2012_CF, ANO_2011_CF, ANO_2010_CF)
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      # variavel para filtra o pais
      pais_filtro <- pais
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      # gera o a tabela control_final
      IDP_Por_Setor_Control_Final <- IDP_Por_Setor_Control_Final %>%
        filter(IDP_Por_Setor_Control_Final$pais %in% pais_filtro)
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      # (Aui a magica acontece) filtra o ano mais atual
      IDP_Por_Setor_Control_Final <- IDP_Por_Setor_Control_Final %>%
        filter(Ano %in% max(Ano))
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      # Seleciona as colunas necessarias
      IDP_Por_Setor_Control_Final <- IDP_Por_Setor_Control_Final %>%
        select(Setores, valor, Ano)
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      IDP_Por_Setor_Control_Final <- IDP_Por_Setor_Control_Final[c(1, 4, 3, 2, 6, 5, 7:nrow(IDP_Por_Setor_Control_Final)), ]
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      # excluia a linha desnecessaria
      linha <- c(7)
      IDP_Por_Setor_Control_Final <- IDP_Por_Setor_Control_Final[-linha, ]
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      #Organiza o nome dos setores
      IDP_Por_Setor_Control_Final[1] <- Investimentos::setores_idp_nomes
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      # transforma NA em 0
      IDP_Por_Setor_Control_Final[is.na(IDP_Por_Setor_Control_Final)] <- 0
      
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      ano_IDP <- max(IDP_Por_Setor_Control_Final$Ano)
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      # Faz o calculo da linha outros e adiciona no data frame
      outros_Control_Final <- outros_func(IDP_Por_Setor_Control_Final, Control_Final_IDP, ano_IDP)
      outros_Control_Final <- mutate(outros_Control_Final, IDP_Por_Setor_Control_Final$Ano[1])
      IDP_Por_Setor_Control_Final[nrow(IDP_Por_Setor_Control_Final) + 1,] <- outros_Control_Final
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      
    }
    
  #*******************************************************************************//************************************************************************************
    if(pais %in% lista_paises_IDP_II){
      #====================================================================== COD Tabela 2==========================================================================
      #                                                                 Coluna Invest. Imed
      #=============================================================================================================================================================
      ANO_2010_INV <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "13", range = "A213:AJ226")
      
      ANO_2011_INV <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "13", range = "A193:AJ206")
      
      ANO_2012_INV <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "13", range = "A173:AJ186")
      
      ANO_2013_INV <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "13", range = "A153:AJ166")
      
      ANO_2014_INV <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "13", range = "A133:AJ146")
      
      ANO_2015_INV <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "13", range = "A113:AJ126")
      
      ANO_2016_INV <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "13", range = "A93:AJ106")
      
      ANO_2017_INV <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "13", range = "A71:AJ84")
      
      ANO_2018_INV <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "13", range = "A49:AJ62")
      
      ANO_2019_INV <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "13", range = "A27:AJ40")
      
      ANO_2020_INV <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "13", range = "A5:AJ18")
      ANO_2020_INV <- turn_numeric(ANO_2020_INV, 36)
      #############################################################################################################################################################
      linhas <- c(1, 2, 3, 7, 10, 11, 13, 15)
      ANO_2010_INV <- ANO_2010_INV[-linhas, ]
      ANO_2010_INV <- pivot_longer_ano(ANO_2010_INV,"Países Baixos", "Curaçao")
      ANO_2010_INV <- IDP_func(ANO_2010_INV, "2010", "ANO: 2010")
      ##############################################################################################################################################################
      
      ANO_2011_INV <- ANO_2011_INV[-linhas, ]
      ANO_2011_INV <- pivot_longer_ano(ANO_2011_INV,"Países Baixos", "Barbados")
      ANO_2011_INV <- IDP_func(ANO_2011_INV, "2011", "ANO: 2011")
      ##############################################################################################################################################################
    
      ANO_2012_INV <- ANO_2012_INV[-linhas, ]
      ANO_2012_INV <- pivot_longer_ano(ANO_2012_INV,"Países Baixos", "Colômbia")
      ANO_2012_INV <- IDP_func(ANO_2012_INV, "2012", "ANO: 2012")
      ##############################################################################################################################################################
      
      ANO_2013_INV <- ANO_2013_INV[-linhas, ]
      ANO_2013_INV <- pivot_longer_ano(ANO_2013_INV,"Países Baixos", "Angola")
      ANO_2013_INV <- IDP_func(ANO_2013_INV, "2013", "ANO: 2013")
      ##############################################################################################################################################################
      
      ANO_2014_INV <- ANO_2014_INV[-linhas, ]
      ANO_2014_INV <- pivot_longer_ano(ANO_2014_INV,"Países Baixos", "Angola")
      ANO_2014_INV <- IDP_func(ANO_2014_INV, "2014", "ANO: 2014")
      ##############################################################################################################################################################
      
      ANO_2015_INV <- ANO_2015_INV[-linhas, ]
      ANO_2015_INV <- pivot_longer_ano(ANO_2015_INV,"Países Baixos", "Curaçao")
      ANO_2015_INV <- IDP_func(ANO_2015_INV, "2015", "ANO: 2015")
      ##############################################################################################################################################################
      
      ANO_2016_INV <- ANO_2016_INV[-linhas, ]
      ANO_2016_INV <- pivot_longer_ano(ANO_2016_INV,"Países Baixos", "Hong Kong")
      ANO_2016_INV <- IDP_func(ANO_2016_INV, "2016", "ANO: 2016")
      ##############################################################################################################################################################
      
      ANO_2017_INV <- ANO_2017_INV[-linhas, ]
      ANO_2017_INV <- pivot_longer_ano(ANO_2017_INV,"Países Baixos", "Finlândia")
      ANO_2017_INV <- IDP_func(ANO_2017_INV, "2017", "ANO: 2017")
      ##############################################################################################################################################################
      
      ANO_2018_INV <- ANO_2018_INV[-linhas, ]
      ANO_2018_INV <- pivot_longer_ano(ANO_2018_INV,"Países Baixos", "Emirados Árabes Unidos")
      ANO_2018_INV <- IDP_func(ANO_2018_INV, "2018", "ANO: 2018")
      ##############################################################################################################################################################
      
      ANO_2019_INV <- ANO_2019_INV[-linhas, ]
      ANO_2019_INV <- pivot_longer_ano(ANO_2019_INV,"Países Baixos", "Hong Kong")
      ANO_2019_INV <- IDP_func(ANO_2019_INV, "2019", "ANO: 2019")
      ##############################################################################################################################################################
      
      ANO_2020_INV <- ANO_2020_INV[-linhas, ]
      ANO_2020_INV <- pivot_longer_ano(ANO_2020_INV,"Países Baixos", "Finlândia")
      ANO_2020_INV <- IDP_func(ANO_2020_INV, "2020", "ANO: 2020")
      ##############################################################################################################################################################
      
    
      IDP_Por_Setor_Inv_Imed <- bind_rows(ANO_2010_INV, ANO_2011_INV, ANO_2012_INV, ANO_2013_INV, ANO_2014_INV, ANO_2015_INV, ANO_2016_INV,
                                          ANO_2017_INV, ANO_2018_INV, ANO_2019_INV, ANO_2020_INV)
      
      IDP_Por_Setor_Inv_Imed <- IDP_Por_Setor_Inv_Imed %>%
        rename(Pais = pais)
      
      
      IDP_Por_Setor_Inv_Imed <- IDP_Por_Setor_Inv_Imed %>%
           filter(IDP_Por_Setor_Inv_Imed$Pais %in% pais)
      
      # teste ano_idp 
      if(pais %in% lista_paises_IDP_CF){
        IDP_Por_Setor_Inv_Imed <- IDP_Por_Setor_Inv_Imed %>%
           filter(Ano %in% ano_IDP)
      }else{
        IDP_Por_Setor_Inv_Imed <- IDP_Por_Setor_Inv_Imed %>%
           filter(Ano %in% max(Ano))
      }
      #----------------------------------------------------------
      IDP_Por_Setor_Inv_Imed <- IDP_Por_Setor_Inv_Imed %>%
          select(Setores, valor, Ano)
  
      IDP_Por_Setor_Inv_Imed[1] <- Investimentos::setores_idp_nomes
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      # transforma NA em 0
      IDP_Por_Setor_Inv_Imed[is.na(IDP_Por_Setor_Inv_Imed)] <- 0
      #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      if(pais %in% lista_paises_IDP_CF){
        outros_Inv_Imed <- outros_func(IDP_Por_Setor_Inv_Imed, Invest_Imediato_IDP, ano_IDP)
      }else{
        outros_Inv_Imed <- outros_func(IDP_Por_Setor_Inv_Imed, Invest_Imediato_IDP, max(IDP_Por_Setor_Inv_Imed$Ano))
      }
      
      outros_Inv_Imed <- mutate(outros_Inv_Imed, IDP_Por_Setor_Inv_Imed$Ano[1])
      IDP_Por_Setor_Inv_Imed[nrow(IDP_Por_Setor_Inv_Imed) + 1,] <- outros_Inv_Imed
    }
       
  #=====================================================================================================================================================================    # 1
    if((pais %in% lista_paises_IDP_II) && (pais %in% lista_paises_IDP_CF)){
      #Junta control_final e invest_imed
      IDP_Por_Setor_Inv_Imed <- IDP_Por_Setor_Inv_Imed %>%
        select(Setores, valor)
        
      IDP_Por_Setor_Control_Final <- IDP_Por_Setor_Control_Final %>%
        select(Setores, valor)
    
     tabela_por_setor <-left_join(IDP_Por_Setor_Inv_Imed, IDP_Por_Setor_Control_Final,by="Setores",suffix = c(".Invest Imediato",".Control Final"))
     tabela_por_setor[is.na(tabela_por_setor)] <- 0
     #-----------------------------------------------------------------------------------------------------------------------------------------------------------
      #Renomeia o nome da coluna setores
      tabela_por_setor <- rename(tabela_por_setor, "Setor" = Setores)
      
    }
  #=====================================================================================================================================================================
  # 2
    if(!(pais %in% lista_paises_IDP_II) && (pais %in% lista_paises_IDP_CF)){
      
      IDP_Por_Setor_Inv_Imed <- IDP_Por_Setor_Control_Final
      
      IDP_Por_Setor_Inv_Imed[1,2] <- 0
      IDP_Por_Setor_Inv_Imed[2,2] <- 0
      IDP_Por_Setor_Inv_Imed[3,2] <- 0
      IDP_Por_Setor_Inv_Imed[4,2] <- 0
      IDP_Por_Setor_Inv_Imed[5,2] <- 0
      IDP_Por_Setor_Inv_Imed[6,2] <- 0
      
      IDP_Por_Setor_Inv_Imed <- IDP_Por_Setor_Inv_Imed %>%
        select(Setores, valor)
      
      linha <- c(7)
      IDP_Por_Setor_Inv_Imed <- IDP_Por_Setor_Inv_Imed[-linha, ]
      
      outros_Inv_Imed <- outros_func(IDP_Por_Setor_Inv_Imed, Invest_Imediato_IDP, ano_IDP)
      outros_Inv_Imed <- mutate(outros_Inv_Imed, IDP_Por_Setor_Inv_Imed$Ano[1])
      IDP_Por_Setor_Inv_Imed[nrow(IDP_Por_Setor_Inv_Imed) + 1,] <- outros_Inv_Imed
      
      IDP_Por_Setor_Control_Final <- IDP_Por_Setor_Control_Final %>%
        select(Setores, valor)
      
       tabela_por_setor <- data.frame(IDP_Por_Setor_Inv_Imed$Setores, IDP_Por_Setor_Inv_Imed$valor, IDP_Por_Setor_Control_Final$valor )
       tabela_por_setor[is.na(tabela_por_setor)] <- 0
       
       tabela_por_setor <- rename(tabela_por_setor, "Setor" = "IDP_Por_Setor_Inv_Imed.Setores" )
       tabela_por_setor <- rename(tabela_por_setor, "valor.Invest Imediato" = "IDP_Por_Setor_Inv_Imed.valor" )
       tabela_por_setor <- rename(tabela_por_setor,  "valor.Control Final" = "IDP_Por_Setor_Control_Final.valor" )
    }
    
    #===============================================================================================================================================================
    # 3
    if((pais %in% lista_paises_IDP_II) && !(pais %in% lista_paises_IDP_CF)){
      
      ano_IDP <- max(IDP_Por_Setor_Inv_Imed$Ano)
      IDP_Por_Setor_Control_Final <- IDP_Por_Setor_Inv_Imed

      IDP_Por_Setor_Control_Final[1,2] <- 0
      IDP_Por_Setor_Control_Final[2,2] <- 0
      IDP_Por_Setor_Control_Final[3,2] <- 0
      IDP_Por_Setor_Control_Final[4,2] <- 0
      IDP_Por_Setor_Control_Final[5,2] <- 0
      IDP_Por_Setor_Control_Final[6,2] <- 0
      
      linha <- c(7)
      IDP_Por_Setor_Control_Final <- IDP_Por_Setor_Control_Final[-linha, ]
      

      outros_Control_Final <- outros_func(IDP_Por_Setor_Control_Final, Control_Final_IDP, max(IDP_Por_Setor_Inv_Imed$Ano))
      outros_Control_Final <- mutate(outros_Control_Final, IDP_Por_Setor_Control_Final$Ano[1])
      IDP_Por_Setor_Control_Final[nrow(IDP_Por_Setor_Control_Final) + 1,] <- outros_Control_Final

      IDP_Por_Setor_Control_Final <- IDP_Por_Setor_Control_Final %>%
        select(Setores, valor)

      IDP_Por_Setor_Inv_Imed <- IDP_Por_Setor_Inv_Imed %>%
        select(Setores, valor)

      tabela_por_setor <- data.frame(IDP_Por_Setor_Inv_Imed$Setores, IDP_Por_Setor_Inv_Imed$valor, IDP_Por_Setor_Control_Final$valor )
      tabela_por_setor[is.na(tabela_por_setor)] <- 0
    
       
      tabela_por_setor <- rename(tabela_por_setor, "Setor" = "IDP_Por_Setor_Inv_Imed.Setores" )
      tabela_por_setor <- rename(tabela_por_setor, "valor.Invest Imediato" = "IDP_Por_Setor_Inv_Imed.valor" )
      tabela_por_setor <- rename(tabela_por_setor,  "valor.Control Final" = "IDP_Por_Setor_Control_Final.valor" )
    }
  }else{
    ano_IDP <- "2020"
    i <- 1
    linha <- c(7)
    
     if((pais[] %in% lista_paises_IDP_II) && (pais[] %in% lista_paises_IDP_CF)){
      for (i in pais) {
        IDP_Por_Setor_Inv_Imed <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "13", range = "A5:AJ20")
        IDP_Por_Setor_Control_Final <- read_xlsx("data-raw/TabelasCompletasPosicaoIDP.xlsx",sheet = "14", range = "A5:AJ20")
        
        # Coluna Invest. Imediato
        IDP_Por_Setor_Inv_Imed <- setores(IDP_Por_Setor_Inv_Imed)
        IDP_Por_Setor_Inv_Imed <- setores_final(IDP_Por_Setor_Inv_Imed, gaveta)
        IDP_Por_Setor_Inv_Imed <- IDP_Por_Setor_Inv_Imed[c(1, 4, 3, 2, 6, 5:nrow(IDP_Por_Setor_Inv_Imed)), ]
        IDP_Por_Setor_Inv_Imed <- IDP_Por_Setor_Inv_Imed[-linha, ]
        IDP_Por_Setor_Inv_Imed[1] <- Investimentos::setores_idp_nomes

          
        # Coluna Control. Final
        IDP_Por_Setor_Control_Final <- setores(IDP_Por_Setor_Control_Final)
        IDP_Por_Setor_Control_Final <- setores_final(IDP_Por_Setor_Control_Final, gaveta)
        IDP_Por_Setor_Control_Final <- IDP_Por_Setor_Control_Final[c(1, 4, 3, 2, 6, 5:nrow(IDP_Por_Setor_Control_Final)), ]
        IDP_Por_Setor_Control_Final <- IDP_Por_Setor_Control_Final[-linha, ]
        IDP_Por_Setor_Control_Final[1] <- Investimentos::setores_idp_nomes

          
         #Calculo da Linha Outros (invest_imed)
        outros_Inv_Imed <- outros_func(IDP_Por_Setor_Inv_Imed, Invest_Imediato_IDP, ano_IDP)
        IDP_Por_Setor_Inv_Imed[nrow(IDP_Por_Setor_Inv_Imed) + 1,] <- outros_Inv_Imed

        
          
        #Calculo da Linha Outros (invest_final)
        outros_Control_Final <- outros_func(IDP_Por_Setor_Control_Final, Control_Final_IDP, ano_IDP)
        IDP_Por_Setor_Control_Final[nrow(IDP_Por_Setor_Control_Final) + 1,] <- outros_Control_Final

      #-----------------------------------------------------------------------------------------------------------------------
        #Junta em 1 só data frame
        tabela_por_setor <-left_join(IDP_Por_Setor_Inv_Imed,IDP_Por_Setor_Control_Final,by="Setores",suffix = c(".Invest Imediato",".Control Final"))
        #Renomeia o nome da coluna setores
        tabela_por_setor <- rename(tabela_por_setor, "Setor" = Setores)
          
      }
     }else{
       tabela_por_setor <- 0
     }
  }
   
  
  if(!(pais %in% lista_paises_IDP_II) && !(pais %in% lista_paises_IDP_CF)){
    ano_IDP <- "2020"
  }
  
```


##  Setor de Atividade Econômica (Estoque `r ano_IDP` - US$ milhões)
```{r,echo=FALSE,menssage=FALSE,warning = FALSE, fig.width=8.5, fig.height=4.5, out.width = "100%"}
# ------------------------------------ * Grafico 2 * ------------------------------------ 
  if(pais %in% lista_paises_IDP_CF){
    if(sum(tabela_por_setor$`Valores.Control Final`) >= 0){
    #Criar uma nova tabela igual a de setor para trabalhar no grafico
    tab_grafico2 <- tabela_por_setor
  #-----------------------------------------------------------------------------------------------------------------
    #Renomeia as colunas para ficar facil de trabalhar
    if(length(pais) == 1){
      #tab_grafico2 <- rename(tab_grafico2, "Setor" = "Setor de atividade econômica (Estoque 2020 - US$ milhões)")
      tab_grafico2 <- rename(tab_grafico2, "Control_Final" = "valor.Control Final")
      tab_grafico2 <- rename(tab_grafico2, "Invest_Imediato" = "valor.Invest Imediato")
    }else{
      #tab_grafico2 <- rename(tab_grafico2, "Setor" = "Setor de atividade econômica (Estoque 2020 - US$ milhões)")
      tab_grafico2 <- rename(tab_grafico2, "Control_Final" = "Valores.Control Final")
      tab_grafico2 <- rename(tab_grafico2, "Invest_Imediato" = "Valores.Invest Imediato")
    }
  #------------------------------------------------------------------------------------------------------------------ 
    
    #Realiza a soma do controle final
    total_control_final <- tab_grafico2 %>% 
        filter(tab_grafico2$Control_Final == max(tab_grafico2$Control_Final)) %>%
        select(-grep("Control_Final", colnames(tab_grafico2))) %>%
        summarise(var = colSums(tab_grafico2[3]))
  #------------------------------------------------------------------------------------------------------------------ 
    
    #Separa a coluna controle final
    coluna_control_final <- tab_grafico2 %>%
      select(Control_Final)
  #------------------------------------------------------------------------------------------------------------------ 
    
    #Calculo do porcentagem final
    tab_grafico2_porcentagem = coluna_control_final * 100 / total_control_final$var
  #------------------------------------------------------------------------------------------------------------------ 
    
    #Add a porcentagem na tabela
    tab_grafico2$porcentagem <-  tab_grafico2_porcentagem$Control_Final
  #------------------------------------------------------------------------------------------------------------------
    #Filtra somente dados maiores que 0 para gerar o grafico
    tab_grafico2 <- tab_grafico2 %>% filter(porcentagem >= 0.01)
    
  #------------------------------------------------------------------------------------------------------------------
    #Cria o grafico
      ggplot(tab_grafico2, aes(x="", y = porcentagem, fill= Setor ),
             label = porcentagem )+
      geom_bar(stat = "identity")+
      coord_polar(theta = "y", start = 0)+
      theme_void()+
      geom_label_repel(label = paste(round(tab_grafico2$porcentagem ,2),"%"), show.legend = F, size = 5,
                       position =  position_stack(vjust = 0.5))
    }
  }else{
    print("Sem dados suficientes para gerar o gráfico!")
  }
```


```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}

  if(length(pais) == 1){
      if(pais %in% lista_paises_IDP_CF || pais %in% lista_paises_IDP_II){
        kableExtra::kable(tabela_por_setor, digits = 2, format = "markdown", align = 'lccc')
    }
  }else{
      kableExtra::kable(tabela_por_setor, digits = 2, format = "markdown", align = 'lccc')
  }


```


```{r, echo=FALSE, message=FALSE,warning = FALSE}
#--------------------------------------------- IDP Quantidade de Investidores Tabela2 --------------------------------------------------

anos15e20 <- c("2015", "2020")

Quantidade_Control_Final  <- ler_excel("data-raw/TabelasCompletasPosicaoIDP.xlsx", "9", 4)

Quantidade_Control_Final <- IDP_Qtd_Invest(Quantidade_Control_Final, anos15e20)

Quantidade_Control_Final <- soma_Qtd_Invest(Quantidade_Control_Final,3 ,anos15e20)

Quantidade_Invest_Imediato <- ler_excel("data-raw/TabelasCompletasPosicaoIDP.xlsx", "8", 4) 

Quantidade_Invest_Imediato <- IDP_Qtd_Invest(Quantidade_Invest_Imediato, anos15e20)

Quantidade_Invest_Imediato <- soma_Qtd_Invest(Quantidade_Invest_Imediato,3 ,anos15e20)

Quantidade_Control_Final <- add_column(Quantidade_Control_Final, Setor = "Controlador Final", .before = 1)

Quantidade_Invest_Imediato <- add_column(Quantidade_Invest_Imediato, Setor = "Investimento Imediato", .before = 1)


#----------------------------------------------------------------------------------------------------------------------------
Qtd_Invest <- full_join(Quantidade_Invest_Imediato, Quantidade_Control_Final)
#----------------------------------------------------------------------------------------------------------------------------
```

## IDP - Quantidade de Investidores (>= 10% capital acionário)
```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}

kableExtra::kable(Qtd_Invest, digits = 2, format = "markdown", align = 'lccc')
```











\newpage
#  Investimentos do Brasil no(a) `r pais_titulo`
```{r, echo=FALSE, message=FALSE, warning = FALSE}
# --------------------------------------------------- Tabela 3 ---------------------------------------------------
# Tabela IBD
tabela_IBD <- bind_rows(Invest_Imediato_IDE,Oper_Intercomp_IDE, Fluxo_Invest_Imediatop_IDE)

setor_tab2 <- c("IBD-Participação no Capital(Invest. Imed)",
                "IBD-Operações Intercompanhia",
                "Fluxo-Participação no Capital(Invest. Imed)")

tabela_IBD <- criar_tabela(tabela_IBD, setor_tab2)

# ------------------------------------------------------------------------------------------------------
# Divide a tabla em 2
tabela_IBD.1 <- tabela_IBD %>% select(names, "2011", "2012", "2013", "2014", "2015")
tabela_IBD.2 <- tabela_IBD %>% select(names, "2016", "2017", "2018", "2019", "2020")

tabela_IBD.1 <- rename(tabela_IBD.1, "Dado" = "names")
tabela_IBD.2 <- rename(tabela_IBD.2, "Dado" = "names")

```


```{r, echo=FALSE,fig.width=8.5, fig.height=4.5, message=FALSE, warning = FALSE, out.width = "100%"}
# ------------------------------------ * Grafico 3 * ------------------------------------ 
  tab_grafico3 <- tabela_IBD
  
  tab_grafico3 <- tab_grafico3 %>% 
    select(names,"2010","2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020")%>%
    pivot_longer(cols = "2010":"2020", names_to = "anos", values_to = "setor") 
  #------------------------------------------------------------------------------------------------------------------ 
  
  a <- tab_grafico3 %>%
    filter("IBD-Participação no Capital(Invest. Imed)" == names)
  
  b <- tab_grafico3 %>%
    filter("IBD-Operações Intercompanhia" == names)
  
  c <- tab_grafico3 %>%
    filter("Fluxo-Participação no Capital(Invest. Imed)" == names)
  
  
  qanos<- nrow(tab_grafico3)
  
  if(sum(a$setor ) > 0 || sum(b$setor) > 0 || sum(c$setor) > 0){
    ggplot(a, aes(x = anos, y = setor ),
           b, aes(y = setor ),
           c, aes(y = setor )
            ) +
      geom_bar(stat = "identity", aes(y = a$setor, fill = "IBD - Participação no Capital (Invest. Imediato)" ), 
               position = position_nudge(x = -.15), width = .3)+
      
      geom_bar(stat = "identity", aes(y = b$setor, fill = "IBD - Operações Intercompanhia"  ), 
               position = position_nudge(x = .15), width = .3)+
      
      geom_line(aes(y = c$setor*10,group = "",  colour = "Fluxo - Participação no Capital (Invest. Imeadiato)"), size = 1, linetype = 1) +
    
      scale_y_continuous("US$ milhões", sec.axis = sec_axis(~ . /10 ))+
      scale_x_yearmon(NULL, format = "%Y", breaks = seq(2010,2020))+
      scale_color_manual(NULL, values = saturation(c("#6959CD","#99b765","#5d83ad"), scalefac(0.8)))+
      scale_fill_manual(NULL, values = saturation(c("#99b765","#5d83ad","#6959CD"), scalefac(0.8)))+
      theme_classic ()+
      theme(panel.grid = element_blank(), # remove as linhas do corpo do gráfico
            # sem bordas entre os painéis
            panel.spacing = unit(0, "cm"),
            # modifica o texto dos eixos
            axis.text = element_text(size = 12, colour = "black"),
            # cor dos marcadores
            axis.ticks = element_line(colour = "black"),
            # tamanho dos marcadores
            axis.ticks.length = unit(.2, "cm"),
            #cor da borda
            panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
            axis.text.x = element_text(angle = 0, hjust = 0.5),
            legend.position="bottom", legend.box = "vertical")
  }else{
    print("Sem dados suficientes para gerar o gráfico!")
  }
```


```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}

  kableExtra::kable(tabela_IBD.1, digits = 2, format = "markdown", align = 'lccccccc')
  
```


```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}

  kableExtra::kable(tabela_IBD.2, digits = 2, format = "markdown" , align = 'lccccccc')
  

```











\newpage
## Investimento em Carteira
```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}
# ----------------------------------------- * Cod tabela 4 * -------------------------------------------------

  setor_tab1 <- c("Ações")
  setor_tab2 <- c("Renda Fixa de Curto Prazo")
  setor_tab3 <- c("Renda Fixa de Longo Prazo")
  
# -----------------------------------------------------------------------------------------------------------  

  a <- criar_tabela(Acoes_IDE, setor_tab1)
  b <- criar_tabela(RF_Curto_Prazo_IDE, setor_tab2)
  c <- criar_tabela(RF_Longo_Prazo_IDE, setor_tab3)
  
# -----------------------------------------------------------------------------------------------------------
  
  tabela_investimento_carteira <- bind_rows(a, b, c)

# -----------------------------------------------------------------------------------------------------------
  
  tabela_investimento_carteira.1 <- tabela_investimento_carteira %>% select(names, "2011", "2012", "2013", "2014", "2015")
  tabela_investimento_carteira.2 <- tabela_investimento_carteira %>% select(names, "2016", "2017", "2018", "2019", "2020")

```


```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE, out.width = "100%"}
# ----------------------------------------- * Grafico 4 * -------------------------------------------------
  tab_grafico4 <- tabela_investimento_carteira
 

  if(sum(tab_grafico4$`2010` > 0) || sum(tab_grafico4$`2011` > 0) || sum(tab_grafico4$`2012` > 0) || sum(tab_grafico4$`2013` > 0) || sum(tab_grafico4$`2014` > 0) ||
     sum(tab_grafico4$`2015` > 0) || sum(tab_grafico4$`2016` > 0) || sum(tab_grafico4$`2017` > 0) || sum(tab_grafico4$`2018` > 0) || sum(tab_grafico4$`2019` > 0) ||
    sum(tab_grafico4$`2020` > 0)){
  # -----------------------------------------------------------------------------------------------------------
      tab_grafico4 <- tab_grafico4 %>% 
          select(names,"2010","2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020")%>%
          pivot_longer(cols = "2010":"2020", names_to = "anos", values_to = "valores")

      a <- tab_grafico4 %>%
        filter("Ações" == names)
      
      b <- tab_grafico4 %>%
        filter("Renda Fixa de Curto Prazo" == names)
      
      c <- tab_grafico4 %>%
        filter("Renda Fixa de Longo Prazo" == names)
   # -----------------------------------------------------------------------------------------------------------  
      
  ggplot(a, aes(x = anos, y = valores),
         b, aes(x = anos, y = valores),
         c, aes(x = anos, y = valores)) +
    
    geom_bar(stat = "identity", aes(y = a$valores, fill = "Ações" ),
             position = position_nudge(x = -.30), width = .3)+
    
    geom_bar(stat = "identity", aes(y = b$valores, fill = "Renda Fixa de Curto Prazo" ), 
             position = position_nudge(x = -0), width = .3)+
    
    geom_bar(stat = "identity", aes(y = c$valores, fill = "Renda Fixa de Longo Prazo" ),
             position = position_nudge(x = .30), width = .3)+
    
    scale_y_continuous("US$ milhões")+
    scale_x_yearmon(NULL, format = "%Y", breaks = seq(2010,2020))+
    scale_fill_manual(NULL, values = saturation(c("#191970","#3CB371","#FF8C00"), scalefac(0.8)))+
    theme_classic ()+
    theme(panel.grid = element_blank(), # remove as linhas do corpo do gráfico
          # sem bordas entre os painéis
          panel.spacing = unit(0, "cm"),
          # modifica o texto dos eixos
          axis.text = element_text(size = 12, colour = "black"),
          # cor dos marcadores
          axis.ticks = element_line(colour = "black"),
          # tamanho dos marcadores
          axis.ticks.length = unit(.2, "cm"), 
          #cor da borda
          panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          legend.position="bottom", legend.box = "vertical")   
  }else{
    print("Sem dados suficientes para gerar o gráfico!")
  }
```


```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}

  tabela_investimento_carteira.1 <- rename(tabela_investimento_carteira.1, "Ativo" = "names")
  kableExtra::kable(tabela_investimento_carteira.1, digits = 2, format = "markdown", align = 'lcccccccccccc')
  
```

```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}

  tabela_investimento_carteira.2 <- rename(tabela_investimento_carteira.2, "Ativo" = "names")
  kableExtra::kable(tabela_investimento_carteira.2, digits = 2, format = "markdown", align = 'lcccccccccccc')
  
```









\newpage
## Outros Investimentos
```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}
# ----------------------------------------- * Cod Tabela 5 * -------------------------------------------------
tabela_moedas_imoveis <- bind_rows(moedas, imoveis)


setor_tab2 <- c("Moedas/Depósitos", "Imóveis") 


tabela_moedas_imoveis <- criar_tabela(tabela_moedas_imoveis, setor_tab2)

tabela_moedas_imoveis.1 <- tabela_moedas_imoveis %>% select(names, "2011", "2012", "2013", "2014", "2015")
tabela_moedas_imoveis.2 <- tabela_moedas_imoveis %>% select(names, "2016", "2017", "2018", "2019", "2020")

```


```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE, out.width = "100%"}
# ----------------------------------------- * Grafico 5 * -------------------------------------------------
  tab_grafico5 <- tabela_moedas_imoveis
  
  tab_grafico5 <- tab_grafico5 %>% 
    select(names,"2010","2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020")%>%
    pivot_longer(cols = "2010":"2020", names_to = "anos", values_to = "valores") 
  #------------------------------------------------------------------------------------------------------------------  
  
  a <- tab_grafico5 %>%
    filter("Moedas/Depósitos" == names)
  
  b <- tab_grafico5 %>%
    filter("Imóveis" == names)
  #------------------------------------------------------------------------------------------------------------------ 
  
  if(sum(a$valores) > 0 || sum(b$valores > 0)){
    ggplot(a, aes(x = anos, y = valores ),
           b, aes(x = anos, y = valores )) +
      geom_bar(stat = "identity", aes(y = a$valores, fill = "Moedas/Depósitos" ), position = position_nudge(x = -.15), width = .3)+
      geom_bar(stat = "identity", aes(y = b$valores, fill = "Imóveis"  ), position = position_nudge(x = .15), width = .3) +
      scale_y_continuous("US$ milhões")+
      scale_x_yearmon(NULL, format = "%Y", breaks = seq(2010,2020))+
      scale_fill_manual(NULL, values = saturation(c("#B22222","#5b80ab"), scalefac(0.8)))+
      theme_classic ()+
      theme(panel.grid = element_blank(), # remove as linhas do corpo do gráfico
            # sem bordas entre os painéis
            panel.spacing = unit(0, "cm"),
            # modifica o texto dos eixos
            axis.text = element_text(size = 12, colour = "black"),
            # cor dos marcadores
            axis.ticks = element_line(colour = "black"),
            # tamanho dos marcadores
            axis.ticks.length = unit(.2, "cm"), 
            #cor da borda
            panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
            axis.text.x = element_text(angle = 0, hjust = 0.5),
            legend.position="bottom", legend.box = "vertical") 
  }else{
    print("Sem dados suficiente para gerar o gráfico")
  }
```


```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}
  tabela_moedas_imoveis.1 <- rename(tabela_moedas_imoveis.1, "Ativo" = "names")
  kableExtra::kable(tabela_moedas_imoveis.1, digits = 2, format = "markdown", align = 'lcccccccccccc')
```

```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}
  tabela_moedas_imoveis.2 <- rename(tabela_moedas_imoveis.2, "Ativo" = "names")
  kableExtra::kable(tabela_moedas_imoveis.2, digits = 2, format = "markdown", align = 'lcccccccccccc')
```









\newpage
## IBD - Setor de Atividade Econômica (2020 - US$ milhões)
```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}

  IBD_Por_Setor <- read_xlsx("data-raw/TabelasCompletasPosicaoIDE.xlsx",sheet = "18", range = "A5:BZ24")

  if(pais[] %in% lista_paises_IBD_por_setor){
      
    # Criar a tabela
     IBD_Por_Setor <- setores_idb(IBD_Por_Setor)
     IBD_Por_Setor <- setores_final(IBD_Por_Setor, TESTE)
     
    # Calculo da linha outros
     IBD_Por_Setor_Outros <- outros_func(IBD_Por_Setor, Invest_Imediato_IDE, "2020")
     IBD_Por_Setor[nrow(IBD_Por_Setor) + 1,] <- IBD_Por_Setor_Outros
     
   }else{
     print("Sem dados suficientes para gerar o gráfico!")
   }
  
  #-------------------------------------------------------------------------------------------------------------------------------
  
  IBD_Qtd_Invest <- ler_excel("data-raw/TabelasCompletasPosicaoIDE.xlsx", "4", 4)
  
  IBD_Qtd_Invest <- rename(IBD_Qtd_Invest, "2020" = "20202/")
  anos15e20 <- c("2015","2020")
  IBD_Qtd_Invest <- IDP_Qtd_Invest(IBD_Qtd_Invest,anos15e20)
  IBD_Qtd_Invest <- soma_Qtd_Invest(IBD_Qtd_Invest,3,anos15e20)
  IBD_Qtd_Invest$Setor <- c("IBD - Quantidade de Investidores")
  
  
  IBD_Qtd_Invest <-  select(IBD_Qtd_Invest, Setor, "2015", "2020")
```


```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE, out.width = "100%"}
# ----------------------------------------- * Grafico 6 * -------------------------------------------------
if(pais %in% lista_paises_IBD_por_setor){
  tab_grafico6 <- IBD_Por_Setor

  # Realiza a soma do controle final
  total_IBD_Por_Setor <- tab_grafico6 %>%
    filter(tab_grafico6$Valores == max(tab_grafico6$Valores)) %>%
    select(-grep("Valores", colnames(tab_grafico6))) %>%
    summarise(var = colSums(tab_grafico6[2]))
  #------------------------------------------------------------------------------------------------------------------

  # Separa a coluna controle final
  coluna_valores_IBD_Por_Setor <- tab_grafico6 %>%
    select(Valores)
  #------------------------------------------------------------------------------------------------------------------

  # Calculo do porcentagem final
  tab_grafico6_porcentagem = coluna_valores_IBD_Por_Setor * 100 / total_IBD_Por_Setor$var
  #------------------------------------------------------------------------------------------------------------------

  # Add a porcentagem na tabela
  tab_grafico6$porcentagem <-  tab_grafico6_porcentagem$Valores
  #------------------------------------------------------------------------------------------------------------------
  
  #Filtra somente dados maiores que 0 para gerar o grafico
   tab_grafico6 <- tab_grafico6 %>% filter(porcentagem >= 0.01)
  #------------------------------------------------------------------------------------------------------------------
  
    ggplot(tab_grafico6, aes(x="", y = porcentagem, fill= Setores), label = value)+
      geom_bar(stat = "identity")+
      coord_polar(theta = "y", start = 0)+
      theme_void()+
      geom_label_repel(label = paste(round(tab_grafico6$porcentagem,2),"%"),
                       show.legend = F,
                       size = 5,
                       position =  position_stack(vjust = 0.5))
}
```


```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}
  if(pais %in% lista_paises_IBD_por_setor){
    kableExtra::kable(IBD_Por_Setor, format = "markdown", digits = 2)
  }
```

## IBD - Quantidade de Investidores (>= 10% capital acionário)
```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}
  
    kableExtra::kable(IBD_Qtd_Invest, digits = 2, format = "markdown", align = 'lcc')
```









\newpage
# Dados comparativos
Esta seção traz análise comparativa com parceiros próximos.


**Observações:**

* Os dados de investimento estão em milhões de dólares e os percentuais dizem respeito ao valor em relação ao montante total levantado pelo Banco Central.

* IDE, se refere a Investimento Direto (brasileiro) no Exterior

* IDP, se refere a Investimento Direto (estrangeiro) no Brasil

* Ambos os fluxos, nesta seção, utilizam o critério do controlador final


```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}
## fazendo data frame IDP

    # Carrega a página 6 da Planilha IDP
    Invest_Imediato_IDP <- ler_excel("data-raw/TabelasCompletasPosicaoIDP.xlsx", "5", 4)

    # Carrega a página 3 da Planilha IDE
    Invest_Imediato_IDE <- ler_excel("data-raw/TabelasCompletasPosicaoIDE.xlsx", "3", 4)

  if((length(pais) == 1) && (pais %in% Invest_Imediato_IDP$Discriminação) && (pais %in% Invest_Imediato_IDE$Discriminação)){
    # Criando rank
    idp <- Invest_Imediato_IDP %>%
      select(Discriminação,"2010", ...3, "2011", ...5, "2012", ...7, "2013", ...9, "2014", ...11, "2015", ...13, "2016", ...15, "2017", ...17,
             "2018", ...19, "2019", ...21, "2020", ...23)  %>%
      slice(-(1:5))%>%
      mutate(tipo = "IDP") %>%
      mutate(rankIDP = dplyr::row_number())
    
    # Descobrindo o rank do país
    posicao_pais_idp <- idp %>%
      dplyr::filter(Discriminação == pais) %>%
      dplyr::ungroup() %>%
      pull(rankIDP)
    
    # Descobrindo ultima linha do df
    ultima_linha_idp <- idp %>%
      dplyr::filter(Discriminação == "Demais") %>%
      dplyr::ungroup() %>%
      pull(rankIDP)
    
    # Excluindo ultimas linhas desnecessárias do df
    idp <- idp %>%
      slice(1:ultima_linha_idp)
    
    # Criando data frame com os ranks
    rank_paises_IDP <- if(posicao_pais_idp == nrow(idp)){
      slice(idp,c( posicao_pais_idp-2, posicao_pais_idp-1, posicao_pais_idp))
    }else{
      if(posicao_pais_idp == 1L){
        slice(idp,c( posicao_pais_idp, posicao_pais_idp+1, posicao_pais_idp+2))
      }else{
        slice(idp,c( posicao_pais_idp-1, posicao_pais_idp, posicao_pais_idp+1))
      }
    }
    
    
    
    ##---------------------------------------------##---------------------------------------------##---------------------------------------------##
    
    ## fazendo data frame IDE
    # Criando rank
    ide <- Invest_Imediato_IDE %>%
      select(Discriminação,  "2010", ...9, "2011", ...11, "2012", ...13, "2013", ...15, "2014", ...17, "2015", ...19, "2016", ...21, "2017", ...23,
             "2018", ...25, "2019", ...27, "2020", ...29)  %>%
      slice(-(1:5))%>%
      mutate(tipo = "IDE") %>%
      mutate(rankIDE = dplyr::row_number())
    
    # Descobrindo o rank do país
    posicao_pais_ide <- ide %>%
      dplyr::filter(Discriminação == pais) %>%
      dplyr::ungroup() %>%
      pull(rankIDE)
    
    # Descobrindo o rank do país
    ultima_linha_ide <- ide %>%
      dplyr::filter(Discriminação == "Demais1/2/") %>%
      dplyr::ungroup() %>%
      pull(rankIDE)
    
    # Excluindo ultimas linhas desnecessárias do df
    ide <- ide %>%
      slice(1:ultima_linha_ide)
    
    # Criando data frame com os ranks
    
    rank_paises_IDE <- if(posicao_pais_ide == nrow(ide)){
      slice(ide,c( posicao_pais_ide-2, posicao_pais_ide-1, posicao_pais_ide))
    }else{
      if(posicao_pais_ide == 1L){
        slice(ide,c( posicao_pais_ide, posicao_pais_ide+1, posicao_pais_ide+2))
      }else{
        slice(ide,c( posicao_pais_ide-1, posicao_pais_ide, posicao_pais_ide+1))
      }
    }
    
    ##------------------------------------------#--------------------------------------#-----------------------------------#----------------------#
    
    #Juntando os df
    
    
    novo_rank_paises_IDP <- rank_paises_IDP%>%
      select(Discriminação, rankIDP, tipo,"2010", "2011","2012","2013","2014","2015","2016","2017","2018","2019", "2020")%>%
      pivot_longer(cols = c("2010", "2011","2012","2013","2014","2015","2016","2017","2018","2019", "2020"), names_to = "ano", values_to = "value")%>%
      rename(rank = rankIDP)
    
    df_percent_idp <- rank_paises_IDP%>%
      select(Discriminação,rankIDP, ...3, ...5, ...7, ...9, ...11, ...13, ...15, ...17, ...19, ...21, ...23)%>%
      rename("2010" = ...3)%>%
      rename("2011" = ...5)%>%
      rename("2012" = ...7)%>%
      rename("2013" = ...9)%>%
      rename("2014" = ...11)%>%
      rename("2015" = ...13)%>%
      rename("2016" = ...15)%>%
      rename("2017" = ...17)%>%
      rename("2018" = ...19)%>%
      rename("2019" = ...21)%>%
      rename("2020" = ...23)%>%
      pivot_longer(cols = c("2010", "2011","2012","2013","2014","2015","2016","2017","2018","2019", "2020"), names_to = "ano", values_to = "percent")%>%
      rename(rank = rankIDP)
    
    novo_rank_paises_IDP <- left_join(novo_rank_paises_IDP, df_percent_idp, by = c('Discriminação', 'ano', 'rank'))
    
    novo_rank_paises_IDP$percent <- as.numeric(novo_rank_paises_IDP$percent)
    
    #-----------------#------------------
    
    novo_rank_paises_IDE <- rank_paises_IDE%>%
      select(Discriminação, rankIDE, tipo,"2010", "2011","2012","2013","2014","2015","2016","2017","2018","2019", "2020")%>%
      pivot_longer(cols = c("2010", "2011","2012","2013","2014","2015","2016","2017","2018","2019", "2020"), names_to = "ano", values_to = "value")%>%
      rename(rank = rankIDE)
    
    df_percent_ide <- rank_paises_IDE%>%
      select(Discriminação,rankIDE, ...9, ...11, ...13, ...15, ...17, ...19, ...21, ...23, ...25, ...27, ...29)%>%
      rename("2010" = ...9)%>%
      rename("2011" = ...11)%>%
      rename("2012" = ...13)%>%
      rename("2013" = ...15)%>%
      rename("2014" = ...17)%>%
      rename("2015" = ...19)%>%
      rename("2016" = ...21)%>%
      rename("2017" = ...23)%>%
      rename("2018" = ...25)%>%
      rename("2019" = ...27)%>%
      rename("2020" = ...29)%>%
      pivot_longer(cols = c("2010", "2011","2012","2013","2014","2015","2016","2017","2018","2019", "2020"), names_to = "ano", values_to = "percent")%>%
      rename(rank = rankIDE)
    
    novo_rank_paises_IDE <- left_join(novo_rank_paises_IDE, df_percent_ide, by = c('Discriminação', 'ano', 'rank'))
    
    novo_rank_paises_IDE$percent <- as.numeric(novo_rank_paises_IDE$percent)
    
    
    
    #dividindo por 100 para botar em porcentagem, o IDP não precisava
    novo_rank_paises_IDE$percent <- novo_rank_paises_IDE$percent / 100
    
    
    df_geral <- bind_rows(novo_rank_paises_IDP, novo_rank_paises_IDE)
    df_geral$value <- as.numeric(df_geral$value)
    df_geral$ano <- as.numeric(df_geral$ano)
  }
```







```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}
  
  if((length(pais) == 1) && (pais %in% Invest_Imediato_IDP$Discriminação) && (pais %in% Invest_Imediato_IDE$Discriminação)){
    # gráfico parceiros próximos
    df_geral %>%
      select(Discriminação, value, rank, tipo, ano)%>%
      filter(ano == max(ano))%>%
      ggplot2::ggplot() +
      ggplot2::geom_col(
        ggplot2::aes(tidytext::reorder_within(Discriminação, value, tipo), value, fill = tipo),
        show.legend = F) +
      ggplot2::geom_col(data = . %>%
                          dplyr::filter(Discriminação == pais),
                        ggplot2::aes(tidytext::reorder_within(Discriminação, value, tipo), value, fill = "red"),
                        show.legend = F) +
      ggplot2::geom_label(ggplot2::aes(tidytext::reorder_within(Discriminação, value, tipo), value,
                                       label = rank)) +
      ggplot2::facet_wrap(~tipo, scales = "free_y") +
      ggplot2::labs(title = NULL,
                    subtitle = NULL,
                    x = NULL, y = NULL, caption = "") +
      ggplot2::coord_flip() +
      ggplot2::theme_minimal() +
      ggplot2::scale_y_continuous(labels = scales::label_number_si()) +
      ggthemes::scale_fill_tableau() +
      tidytext::scale_x_reordered()+
      ggplot2::labs(title = glue::glue("Brasil - {pais}, parceiros de investimento próximos, em 2020"),
                    caption = "Fonte: Banco Central", x = NULL, y = NULL)
  }else{
  print("Sem dados suficientes para gerar o gráfico!")
}

```

   
       
           
               
                  
\newpage             
```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}
  if((length(pais) == 1) &&( pais %in% Invest_Imediato_IDP$Discriminação) && (pais %in% Invest_Imediato_IDE$Discriminação)){   
    # gráfico proporção parceiros próximos
      proporção <- df_geral %>%
        select(Discriminação, percent, rank, tipo, ano)%>%
        filter(ano == max(ano))
    
    
        ggplot(proporção, aes(x = percent, y = rank, group = " " ))+
          geom_point()+
          geom_point(data = proporção %>%
                       dplyr::filter(proporção$Discriminação == pais), ggplot2::aes(color = Discriminação), show.legend = F)+
          geom_label_repel(label = proporção$Discriminação)+
          theme_minimal()+
          scale_y_reverse(breaks = scales::breaks_pretty(), labels = scales::label_ordinal())+
          scale_x_continuous(labels = scales::label_percent())+
          facet_wrap(~tipo, scales = "free_y")+
          ggplot2::labs(title = glue::glue("Brasil - {pais}, ranking e proporção de Investimentos, em 2020"),
                        caption = "Fonte: Banco Central", x = NULL, y = NULL)
  }else{
  print("Sem dados suficientes para gerar o gráfico!")
}
```


\newpage
\landscape
```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE,l}
  if((length(pais) == 1) && (pais %in% Invest_Imediato_IDP$Discriminação) && (pais %in% Invest_Imediato_IDE$Discriminação)){
    # gráfico evolução parceiros próximos
    df_geral %>%
      ggplot2::ggplot(ggplot2::aes(ano, value)) +
      ggplot2::geom_point() +
      ggplot2::geom_line(ggplot2::aes(color = Discriminação,
                                      group = Discriminação),
                         size = 1.5,
                         linetype = 4,
                         show.legend = F) +
      ggplot2::geom_line(data = . %>%
                           dplyr::filter(Discriminação == pais),
                         ggplot2::aes(color = Discriminação,
                                      group = Discriminação),
                         size = 3,
                         show.legend = F) +
    
      ggrepel::geom_label_repel(data = . %>%
                                  dplyr::filter(ano == max(ano) |
                                                  ano == min(ano) |
                                                  ano == max(ano)-(max(ano)-min(ano))/2),
                                ggplot2::aes(ano, value, label = Discriminação),
                                size = 2, show.legend = F) +
    
      ggplot2::facet_wrap(~ tipo, scales = "free",
                          nrow = 2) +
      ggthemes::scale_color_tableau() +
      ggplot2::theme_minimal() +
      ggplot2::labs(title = NULL,
                    caption = NULL,
                    x = NULL, y = NULL)+
      ggplot2::scale_y_continuous(labels = scales::label_number_si())+
      ggplot2::scale_x_continuous(limits = c(2010, 2020),
                                  breaks = scales::breaks_pretty())+
      ggplot2::labs(title = glue::glue("Brasil - {pais}, evolução do investimento até 2020"),
                    caption = "Fonte: Banco Central", x = NULL, y = NULL)
  }else{
  print("Sem dados suficientes para gerar o gráfico!")
}
```
\endlandscape



\newpage
## Evolução do investimento nos últimos 3 anos disponíveis
```{r, echo=FALSE,fig.width=10, fig.height=5.8, message=FALSE,warning = FALSE}
# Parceiros próximos
  if((length(pais) == 1) && (pais %in% Invest_Imediato_IDP$Discriminação) && (pais %in% Invest_Imediato_IDE$Discriminação)){
    pp <- df_geral %>%
      rename(pct_percent = percent)%>%
      dplyr::group_by(Discriminação, tipo) %>%
      dplyr::arrange(dplyr::desc(ano), .by_group = T) %>%
      dplyr::mutate(pct_var = value/dplyr::lead(value)-1) %>%
      dplyr::ungroup() %>%
      dplyr::filter(ano >= max(ano)-3) %>%
      dplyr::select(-c(rank)) %>%
      dplyr::group_by(ano, tipo) %>%
      dplyr::arrange(dplyr::desc(value), .by_group = T) %>%
      dplyr::arrange(dplyr::desc(ano)) %>%
      dplyr::relocate(ano, tipo, Discriminação, value, .data$pct_var, .data$pct_percent) %>%
      dplyr::mutate(dplyr::across(dplyr::starts_with("val"), scales::label_number_si(accuracy = 0.01))) %>%
      dplyr::mutate(dplyr::across(dplyr::starts_with("pct_") , scales::label_percent(decimal.mark = ",", accuracy = .01)))
  
    pp$tipo <- ifelse(pp$tipo == "IDE", "Inv. direto no exterior","Inv. direto no país")
  
  
    pp %>%
      kableExtra::kbl(booktabs = T, col.names = c("Ano", "Tipo", "Pa\u00eds", "Valor", "Varia\u00e7\u00e3o", "Propor\u00e7\u00e3o")) %>%
      kableExtra::kable_styling(font_size = 7, full_width = T, latex_options = c("hold_position")) %>%
      kableExtra::column_spec(3, width = "20em") %>%
      kableExtra::collapse_rows(columns = 1:2, latex_hline = "full", valign = "top",
                                row_group_label_position = "stack", target = 2) %>%
      kableExtra::add_header_above(header = c(setNames(6,"Comércio Intraindústria e Índice de Concentração")), bold = T) %>%
      kableExtra::row_spec(which(pp$Discriminação == pais), bold = T) %>%
      kableExtra::column_spec(1:2, background = "white", color = "black")
  }else{
  print("Sem dados suficientes para gerar o gráfico!")
}
```

